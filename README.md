# Telegram-–±–æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (aiogram 3.x)

Production-ready –∫–∞—Ä–∫–∞—Å Telegram-–±–æ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (`solo`/`team`) —Å:
- –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é –≤ Telegram;
- –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π —Å–æ–±—ã—Ç–∏–π –≤ –∫–∞–Ω–∞–ª;
- –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏;
- –æ—á–µ—Ä–µ–¥—å—é –æ–∂–∏–¥–∞–Ω–∏—è (FIFO) + –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è/—Ç–∞–π–º–∞—É—Ç—ã 12h;
- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –∑–∞ 24h + —Ç–∞–π–º–∞—É—Ç 12h;
- –ø–∏–Ω–≥–∞–º–∏ –∑–∞ 4 –¥–Ω—è (–ø—Ä–æ—Ö–æ–¥–∫–∏) –∏ 2 —á–∞—Å–∞;
- –∞–≤—Ç–æ-–ø–æ—Å—Ç–æ–º –æ —Å—Ç–∞—Ä—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ-–ø–æ—Å—Ç–æ–º –∑–∞ 1 —á–∞—Å –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏;
- –ª–∏—á–Ω—ã–º–∏ —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (`/start`) –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è, —Å—Ç–∞—Ä—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∑–∞ 1 —á–∞—Å –¥–æ –∫–æ–Ω—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏;
- —ç–∫—Å–ø–æ—Ä—Ç–∞–º–∏ CSV/XLSX;
- Celery + Redis –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞;
- PostgreSQL + Alembic.

## 1. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- Python 3.11+
- aiogram 3.x
- SQLAlchemy 2.x async + asyncpg
- Alembic
- Celery + Redis + Celery Beat
- Docker / docker-compose
- pytest + pytest-asyncio

## 2. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 2.1 –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
1. –ß–µ—Ä–µ–∑ `@BotFather` —Å–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞.
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ `.env`.

### 2.2 –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å `.env`
```bash
cp .env.example .env
```
–ó–∞–ø–æ–ª–Ω–∏—Ç—å:
- `BOT_TOKEN`
- `ADMIN_IDS` –∏ `SUPER_ADMIN_IDS` (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `CHANNEL_ID` (–Ω–∞–ø—Ä–∏–º–µ—Ä `-100...`)
- `MASS_SEND_DELAY_SECONDS` (–∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏)

### 2.3 –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
```bash
docker compose up -d db redis
```

### 2.4 –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
docker compose run --rm bot alembic upgrade head
```

### 2.5 –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –≤–æ—Ä–∫–µ—Ä–æ–≤
```bash
docker compose up -d bot worker beat
```

## 3. –ü—Ä–∞–≤–∞ –≤ –∫–∞–Ω–∞–ª–µ
–î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –∫–∞–Ω–∞–ª:
1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–æ–º –∫–∞–Ω–∞–ª–∞.
2. –î–∞–π—Ç–µ –ø—Ä–∞–≤–æ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ñ–æ—Ç–æ.
3. –£–∫–∞–∂–∏—Ç–µ `CHANNEL_ID` –≤ `.env`.

## 4. –ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/start`
- `üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è`
- `üßæ –ú–æ–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏`
- `üïí –õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è`
- `üë§ –ü—Ä–æ—Ñ–∏–ª—å`
- `‚ÑπÔ∏è –ü–æ–º–æ—â—å`

## 5. –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞
- `/admin`
- `/health`
- `/add_admin <tg_id>` (super-admin)
- `/remove_admin <tg_id>` (super-admin)
- `/backup_db`
- `/rebuild_scheduler`
- `/reschedule_event`

`üì£ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∫–∞–Ω–∞–ª` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞:
- –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Ä–∞–∑—É;
- –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è (–¥–∞—Ç–∞/–≤—Ä–µ–º—è UTC).

## 6. –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- –û–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `status=published` –∏ `registration_start_at <= now <= registration_end_at`.
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
  - `solo`: –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  - `team`: –∫–∞–ø–∏—Ç–∞–Ω —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- Waitlist FIFO:
  - –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç -> `waitlist`;
  - –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ -> `invited_from_waitlist` –∏ 12h –Ω–∞ –æ—Ç–≤–µ—Ç;
  - `–î–∞` -> `registered`, `–ù–µ—Ç` -> `declined`, timeout -> `auto_declined`.
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 24h:
  - –∑–∞–ø—Ä–æ—Å + 12h —Ç–∞–π–º–µ—Ä;
  - `–ü–æ–π–¥—É` -> `confirmed`, `–ù–µ –ø–æ–π–¥—É` -> `declined`, timeout -> `auto_declined`.
- –ü–∏–Ω–≥ –∑–∞ 2h: —Ç–æ–ª—å–∫–æ `confirmed`.
- –ü–∏–Ω–≥ –∑–∞ 4 –¥–Ω—è: —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å `not_mipt`.

## 7. –≠–∫—Å–ø–æ—Ä—Ç—ã
–ê–¥–º–∏–Ω-–º–µ–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –≤—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ CSV;
- —Ç–æ–ª—å–∫–æ confirmed CSV;
- –ø—Ä–æ—Ö–æ–¥–∫–∏ (not_mipt) CSV;
- –≤—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ XLSX.

–ü—Ä–∏–º–µ—Ä—ã –ª–µ–∂–∞—Ç –≤ `examples/exports/`.

## 8. –¢–µ—Å—Ç—ã
```bash
pip install -e .[dev]
pytest -q
```

–ü–æ–∫—Ä—ã—Ç–æ:
- –ª–∏–º–∏—Ç—ã + —Å–æ–∑–¥–∞–Ω–∏–µ waitlist;
- –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ waitlist + 12h timeout;
- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -24h + 12h timeout;
- –æ—Ç–º–µ–Ω–∞ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç;
- smoke –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤.

## 9. –ë—ç–∫–∞–ø/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
–ë—ç–∫–∞–ø:
```bash
docker compose exec db pg_dump -U postgres hb_bot > backup.sql
```
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:
```bash
docker compose exec -T db psql -U postgres hb_bot < backup.sql
```

## 10. –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```text
app/
  handlers/
  services/
  repositories/
  models/
  jobs/
  utils/
migrations/
tests/
```

## 11. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ü–î–Ω
- –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –ø–æ–ª—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º.
- –õ–æ–≥–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- –§–∞–∫—Ç —Å–æ–≥–ª–∞—Å–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è: `pd_consent_at`, `pd_consent_version`.
